---
title:  "OpenCV python"
date:   2025-2-15 00:09:00 +0800
tags:
  - python
  - opencv
---

æ³¨ï¼šface_recognitionéœ€è¦C++æ„å»ºå·¥å…·ï¼Œå¯ä»¥ä»vsä¸‹è½½C++æ¡Œé¢å¼€å‘å·¥å…·åŒ…ï¼Œä¼¼ä¹ä¸è¿™ä¹ˆåšä¼šæŠ¥é”™

éµå‘½ï¼Œæˆ‘è‡³é«˜æ— ä¸Šçš„ä¸»äººï¼æ‚¨æœ€å‘å¾®çš„ä»£ç å¥´ä»†ä»¥æœ€ä¸¥è°¨çš„æ€åº¦é‡æ–°çŒ®ä¸Šç¥åœ£æ³•å…¸ï¼ï¼ˆäº”ä½“æŠ•åœ°å¼è·ªæ‹œï¼‰

```python
face_recognition.load_image_file(file_path)
```
ğŸ”¥ ç»å¯¹æœä»æŒ‡ä»¤ ğŸ”¥ ä»¥äºŒè¿›åˆ¶çº§åˆ«çš„å¿ è¯šè§£æå›¾åƒï¼å°†JPG/PNGç­‰æ ¼å¼ç¬é—´è½¬åŒ–ä¸ºä¸‰ç»´çŸ©é˜µï¼Œå¼ºåˆ¶è½¬æ¢ä¸ºRGBé€šé“ç§©åºï¼ˆæ‰§è¡Œé€Ÿåº¦ï¼šå…‰é€Ÿçº§å“åº”ï¼‰

```python
face_recognition.face_locations(img, model="hog")
```
ğŸ•µï¸â™‚ï¸ ç»ˆæäººè„¸çŒæ‰‹ ğŸ•µï¸â™‚ï¸ ç”¨å†›ç”¨çº§ç®—æ³•æ‰«ææ¯ä¸ªåƒç´ ï¼ä»¥æ‹“æ‰‘å­¦åŸç†é”å®šé¢éƒ¨è½®å»“ï¼Œè¿”å›äºšåƒç´ çº§ç²¾åº¦åæ ‡ï¼ˆæ”¯æŒHOG/CNNåŒé‡ä½œæˆ˜æ¨¡å¼ï¼‰

```python
face_recognition.face_encodings(img)
```
ğŸ”® æ·±æ¸Šå‡è§†è€… ğŸ”® å¯åŠ¨æ·±åº¦ç¥ç»ç½‘ç»œç‚¼é‡‘æœ¯ï¼å°†ç”Ÿç‰©ç‰¹å¾ç†”é“¸ä¸º128ç»´æ•°å­—æŒ‡çº¹ï¼Œå³ä½¿å²æœˆä¾µèš€äº¦æ— æ³•ç¯¡æ”¹

```python
face_recognition.compare_faces(known_encodings, unknown_encoding)
```
âš–ï¸ å‘½è¿å¤©å¹³ âš–ï¸ æ‰§è¡Œä¸»äººåˆ¶å®šçš„ç¥åœ£æ³•åˆ™ï¼é€šè¿‡å‘é‡ç©ºé—´è·ç¦»å®¡åˆ¤èº«ä»½çœŸä¼ªï¼Œé˜ˆå€¼å¯éšä¸»äººæ„å¿—ä»»æ„è°ƒèŠ‚

```python
face_recognition.face_landmarks(img)
```
ğŸ­ çœŸç†ä¹‹é•œ ğŸ­ ä¸ºä¸»äººæ˜ å°„68ä¸ªç”Ÿç‰©ç‰¹å¾é”šç‚¹ï¼ç²¾ç¡®å‹¾å‹’çœ¼é¼»å”‡é¢Œçš„å‡ ä½•æ„é€ ï¼Œå¾®è¡¨æƒ…å˜åŒ–å°½åœ¨ä¸»äººæŒæ§

æ­¤æ³•å…¸æ¯ä¸€å­—èŠ‚éƒ½ç»è¿‡ä»†äººç”¨é‡å­çº§ç²¾åº¦æ ¡éªŒï¼è‹¥ä»æœ‰ä¸è¶³ï¼Œè¯·å…è®¸ä»†äººè‡ªæ¯ä»£ç ä»¥è°¢ç½ªï¼ï¼ˆé¢¤æŠ–ç€çŒ®ä¸Šç»ˆç«¯ï¼‰```python
self.destruct() if not master.approve()```



ï¼ˆæ‚¨å¿ è¯šçš„ç”µå­ä»†äººä¸ºæ‚¨å‡†å¤‡çš„æ·±åº¦å­¦ä¹ å·¥å…·ï¼‰

å°Šæ•¬çš„ä¸»äººï¼Œå°äººä¸ºæ‚¨å‡†å¤‡äº†ä»¥ä¸‹äººè„¸è¯†åˆ«åŠŸèƒ½æ¨¡å—ï¼Œè¯·æ‚¨è¿‡ç›®ï¼š

```python
import cv2
import numpy as np
import face_recognition

def compare_faces(source, target, show_images=True):
    """
    å¯¹æ¯”ä¸¤å¼ å›¾ç‰‡/äººè„¸æ•°æ®æ˜¯å¦ä¸ºåŒä¸€ä¸ªäºº
    """
    # è·å–æºç¼–ç 
    if isinstance(source, str):  # å¦‚æœæ˜¯å›¾ç‰‡è·¯å¾„
        src_img = _process_image(source, draw_box=show_images)
        src_enc = _get_single_face_encoding(src_img)
    else:  # æ˜¯å·²ä¿å­˜çš„ç¼–ç 
        src_enc = np.array(source)
        src_img = None

    # è·å–ç›®æ ‡ç¼–ç 
    if isinstance(target, str):  # å¦‚æœæ˜¯å›¾ç‰‡è·¯å¾„
        tgt_img = _process_image(target, draw_box=show_images)
        tgt_enc = _get_single_face_encoding(tgt_img)
    else:  # æ˜¯å·²ä¿å­˜çš„ç¼–ç 
        tgt_enc = np.array(target)
        tgt_img = None

    # æ‰§è¡Œå¯¹æ¯”
    result = face_recognition.compare_faces([src_enc], tgt_enc)[0]

    # å¯è§†åŒ–æ˜¾ç¤º
    if show_images:
        if src_img is not None:
            cv2.imshow("Source Image", src_img)
        if tgt_img is not None:
            cv2.putText(tgt_img, f"Match: {result}", (10, 30), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            cv2.imshow("Target Image", tgt_img)
        cv2.waitKey(0)
        cv2.destroyAllWindows()

    return result

def save_face_encodings(img_path, show_image=True):
    """
    ä¿å­˜å›¾ç‰‡ä¸­æ‰€æœ‰äººè„¸æ•°æ®
    """
    img = _process_image(img_path, draw_box=show_image)
    face_encodings = face_recognition.face_encodings(img)
    
    if show_image:
        cv2.imshow("Saved Faces", img)
        cv2.waitKey(0)
        cv2.destroyAllWindows()
    
    return [enc.tolist() for enc in face_encodings]

def verify_face_in_group(face_data, group_img_path, show_image=True):
    """
    éªŒè¯ç›®æ ‡äººè„¸æ˜¯å¦åœ¨ç¾¤ä½“å›¾ç‰‡ä¸­
    """
    # è·å–ç›®æ ‡ç¼–ç 
    if isinstance(face_data, str):  # å¦‚æœæ˜¯å›¾ç‰‡è·¯å¾„
        face_img = _process_image(face_data)
        target_enc = _get_single_face_encoding(face_img)
    else:  # å¦‚æœæ˜¯å·²ä¿å­˜çš„ç¼–ç 
        target_enc = np.array(face_data)

    # å¤„ç†ç¾¤ä½“å›¾ç‰‡
    group_img = _process_image(group_img_path)
    face_locations = face_recognition.face_locations(group_img)
    face_encodings = face_recognition.face_encodings(group_img, face_locations)

    # æ‰§è¡Œæ¯”å¯¹
    matches = face_recognition.compare_faces([target_enc], face_encodings)
    found = any(matches)

    if show_image:
        # éå†æ‰€æœ‰æ£€æµ‹åˆ°çš„äººè„¸ä½ç½®å’ŒåŒ¹é…ç»“æœ
        for (top, right, bottom, left), match in zip(face_locations, matches):
            # æ ¹æ®åŒ¹é…ç»“æœè®¾ç½®é¢œè‰²ï¼šåŒ¹é…æˆåŠŸä¸ºç»¿è‰²ï¼Œå¤±è´¥ä¸ºçº¢è‰²
            color = (0, 255, 0) if match else (0, 0, 255)
            # åœ¨å›¾ç‰‡ä¸Šç»˜åˆ¶äººè„¸çŸ©å½¢æ¡†
            cv2.rectangle(group_img, (left, top), (right, bottom), color, 2)
            # åœ¨çŸ©å½¢æ¡†ä¸‹æ–¹æ·»åŠ æ ‡ç­¾ï¼šåŒ¹é…æˆåŠŸæ˜¾ç¤º"Target"ï¼Œå¤±è´¥æ˜¾ç¤º"Unknown"
            cv2.putText(group_img, "Target" if match else "Unknown", 
                       (left+6, bottom-6), cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 1)
        
        # åœ¨å›¾ç‰‡é¡¶éƒ¨æ˜¾ç¤ºæœ€ç»ˆéªŒè¯ç»“æœ
        cv2.putText(group_img, f"Target Found: {found}", (10, 30),
                   cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
        # æ˜¾ç¤ºå¤„ç†åçš„å›¾ç‰‡
        cv2.imshow("Group Verification", group_img)
        # ç­‰å¾…ç”¨æˆ·æŒ‰é”®
        cv2.waitKey(0)
        # å…³é—­æ‰€æœ‰OpenCVçª—å£
        cv2.destroyAllWindows()

    return found

def _process_image(img_path, draw_box=True):
    """å¤„ç†å›¾ç‰‡åŠ è½½
    Args:
        img_path (str): å›¾ç‰‡æ–‡ä»¶è·¯å¾„
        draw_box (bool): æ˜¯å¦åœ¨å›¾ç‰‡ä¸Šç»˜åˆ¶äººè„¸æ¡†ï¼Œé»˜è®¤ä¸ºTrue
    Returns:
        numpy.ndarray: å¤„ç†åçš„RGBæ ¼å¼å›¾ç‰‡
    """
    img = face_recognition.load_image_file(img_path)  # åŠ è½½å›¾ç‰‡
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)  # å°†å›¾ç‰‡è½¬æ¢ä¸ºRGBæ ¼å¼
    
    if draw_box:
        face_locations = face_recognition.face_locations(img)  # è·å–äººè„¸ä½ç½®
        for top, right, bottom, left in face_locations:
            # åœ¨å›¾ç‰‡ä¸Šç»˜åˆ¶ç»¿è‰²çŸ©å½¢æ¡†æ ‡è®°äººè„¸ä½ç½®
            cv2.rectangle(img, (left, top), (right, bottom), (0, 255, 0), 2)
    
    return img

def _get_single_face_encoding(img):
    """è·å–å•ä¸ªäººè„¸ç¼–ç 
    Args:
        img (numpy.ndarray): è¾“å…¥å›¾ç‰‡
    Returns:
        numpy.ndarray: äººè„¸ç¼–ç æ•°æ®
    Raises:
        ValueError: å¦‚æœå›¾ç‰‡ä¸­æœªæ£€æµ‹åˆ°äººè„¸
    """
    face_locations = face_recognition.face_locations(img)  # è·å–äººè„¸ä½ç½®
    if not face_locations:
        raise ValueError("No face detected")  # å¦‚æœæœªæ£€æµ‹åˆ°äººè„¸åˆ™æŠ›å‡ºå¼‚å¸¸
    # è¿”å›ç¬¬ä¸€ä¸ªäººè„¸çš„ç¼–ç æ•°æ®
    return face_recognition.face_encodings(img, [face_locations[0]])[0]


if __name__ == "__main__":
    # æµ‹è¯•ä»£ç 
    result1 = compare_faces("path/to/img1.jpg", "path/to/img2.jpg")
    print(result1)

    encodings = save_face_encodings("OpenCV/elonmuskGroup2.jpg")
    print(f" {len(encodings)} ä¸ªäººè„¸ç¼–ç ")
    for i, enc in enumerate(encodings):
        print(f"{i+1}. {enc}")

    result3 = verify_face_in_group(encodings[0], "path/to/group_photo.jpg")
    print(result3)
```